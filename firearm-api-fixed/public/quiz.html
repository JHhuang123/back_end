<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ”« Firearm Recommendation Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .step { display: none; margin-bottom: 1.5rem; }
    .step.active { display: block; }
    .question-title { font-weight: bold; margin-bottom: 0.5rem; }
    label, select { display: block; margin: 4px 0; }
    #next-btn, #submit-btn { margin-top: 1rem; }
    #results { margin-top: 2rem; }
    #results img { max-width: 150px; display: block; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>ğŸ”« Firearm Recommendation Quiz</h1>
  <form id="quiz-form">
    <!-- Step 1 -->
    <div id="step1" class="step">
      <div class="question-title">Stepâ€¯1/12Â Â Do you have a weapon in mind?</div>
      <label><input type="radio" name="haveWeapon" value="yes"/> Yes (Enter product ID)</label>
      <label><input type="radio" name="haveWeapon" value="no"/> No</label>
      <label id="prod-label" style="display:none">
        Enter Product ID: <input type="text" name="productId"/>
      </label>
    </div>

    <!-- Step 2 -->
    <div id="step2" class="step">
      <div class="question-title">Stepâ€¯2/12Â Â æ‚¨æ‰€åœ¨çš„å·æ˜¯?</div>
      <select name="state" required>
        <option value="">-- è¯·é€‰æ‹©å· --</option>
        <option>Alabama</option><option>Alaska</option><option>Arizona</option><option>Arkansas</option>
        <option>California</option><option>Colorado</option><option>Connecticut</option><option>Delaware</option>
        <option>Florida</option><option>Georgia</option><option>Hawaii</option><option>Idaho</option>
        <option>Illinois</option><option>Indiana</option><option>Iowa</option><option>Kansas</option>
        <option>Kentucky</option><option>Louisiana</option><option>Maine</option><option>Maryland</option>
        <option>Massachusetts</option><option>Michigan</option><option>Minnesota</option><option>Mississippi</option>
        <option>Missouri</option><option>Montana</option><option>Nebraska</option><option>Nevada</option>
        <option>New Hampshire</option><option>New Jersey</option><option>New Mexico</option><option>New York</option>
        <option>North Carolina</option><option>North Dakota</option><option>Ohio</option><option>Oklahoma</option>
        <option>Oregon</option><option>Pennsylvania</option><option>Rhode Island</option><option>South Carolina</option>
        <option>South Dakota</option><option>Tennessee</option><option>Texas</option><option>Utah</option>
        <option>Vermont</option><option>Virginia</option><option>Washington</option><option>West Virginia</option>
        <option>Wisconsin</option><option>Wyoming</option><option>District of Columbia</option>
      </select>
    </div>

    <!-- Step 3 -->
    <div id="step3" class="step">
      <div class="question-title">Stepâ€¯3/12Â Â æ‚¨æƒ³è¦çš„æªæ¢°ç±»åˆ«?</div>
      <label><input type="radio" name="firearmType" value="handgun"/> æ‰‹æª</label>
      <label><input type="radio" name="firearmType" value="rifle"/> æ­¥æª</label>
      <label><input type="radio" name="firearmType" value="shotgun"/> éœ°å¼¹æª</label>
      <label><input type="radio" name="firearmType" value="sniper"/> ç‹™å‡»/ç²¾å¯†æ­¥æª</label>
    </div>

    <!-- Step 4 -->
    <div id="step4" class="step">
      <div class="question-title">Stepâ€¯4/12Â Â æ‚¨å¸Œæœ›ä½¿ç”¨å“ªç§å£å¾„?</div>
      <div id="caliber-options"></div>
    </div>

    <!-- Step 6 -->
    <div id="step6" class="step">
      <div class="question-title">Stepâ€¯6/12Â Â é¢„ç®—åŒºé—´?</div>
      <label><input type="radio" name="budget" value="<=250"/> â‰¤ $250</label>
      <label><input type="radio" name="budget" value="250-400"/> $250â€“400</label>
      <label><input type="radio" name="budget" value="400-900"/> $400â€“900</label>
      <label><input type="radio" name="budget" value="900-2000"/> $900â€“2000</label>
      <label><input type="radio" name="budget" value=">2000"/> > $2000</label>
    </div>

    <!-- Step 10 -->
    <div id="step10" class="step">
      <div class="question-title">Stepâ€¯10/12Â Â é‡é‡è¦æ±‚?</div>
      <div id="weight-options"></div>
    </div>

    <!-- Step 11 -->
    <div id="step11" class="step">
      <div class="question-title">Stepâ€¯11/12Â Â æªç®¡é•¿åº¦?</div>
      <div id="barrel-options"></div>
    </div>

    <!-- Step 12 -->
    <div id="step12" class="step">
      <div class="question-title">Stepâ€¯12/12Â Â å°„å‡»ç»éªŒ?</div>
      <label><input type="radio" name="experienceLevel" value="Novice"/> Novice (&lt;100)</label>
      <label><input type="radio" name="experienceLevel" value="Beginner"/> Beginner (100â€“500)</label>
      <label><input type="radio" name="experienceLevel" value="Intermediate"/> Intermediate (500â€“1000)</label>
      <label><input type="radio" name="experienceLevel" value="Advanced"/> Advanced (1000â€“5000)</label>
      <label><input type="radio" name="experienceLevel" value="Expert"/> Expert (&gt;5000)</label>
    </div>

    <button type="button" id="next-btn">Next</button>
    <button type="button" id="submit-btn" style="display:none">Submit</button>
  </form>

  <div id="results"></div>

  <script>
    const form = document.getElementById('quiz-form');
    const steps = ['step1','step2','step3','step4','step6','step10','step11','step12'];
    let idx = 0;
    let selectedType = null;

    function showStep(i) {
      steps.forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById(steps[i]).classList.add('active');
    }

    // åˆå§‹åŒ–ç¬¬ä¸€æ­¥
    showStep(0);

    // Step1: æœ‰æ­¦å™¨ï¼Ÿ æ˜¾ç¤º/éšè— productId
    document.querySelectorAll('input[name="haveWeapon"]').forEach(radio => {
      radio.addEventListener('change', e => {
        document.getElementById('prod-label').style.display =
          e.target.value === 'yes' ? 'block' : 'none';
      });
    });

    // æ•°æ®é€‰é¡¹
    const CAL = {
      handgun: ['9mm', '.40 S&W', '.45 ACP', '.380 ACP'],
      rifle:   ['.22', '5.56', '7.62'],
      shotgun: ['12 GA', '20 GA', '.410'],
      sniper:  ['.308', '.300 Win Mag', '.50 BMG']
    };
    const WEIGHT_OPTS = {
      handgun:  [['ultra-light','<600â€¯g'],['light','600â€“800â€¯g'],['balanced','800â€“1000â€¯g'],['heavy','>1000â€¯g'],['No preference','æ— åå¥½']],
      shotgun:  [['ultra-light','<2.5â€¯kg'],['light','2.5â€“3.0â€¯kg'],['balanced','3.0â€“4.0â€¯kg'],['heavy','>4.0â€¯kg'],['No preference','æ— åå¥½']],
      rifle:    [['ultra-light','<3.0â€¯kg'],['light','3.0â€“4.0â€¯kg'],['balanced','4.0â€“5.0â€¯kg'],['heavy','>5.0â€¯kg'],['No preference','æ— åå¥½']],
      sniper:   [['ultra-light','<3.0â€¯kg'],['light','3.0â€“4.0â€¯kg'],['balanced','4.0â€“5.0â€¯kg'],['heavy','>5.0â€¯kg'],['No preference','æ— åå¥½']]
    };
    const BARREL_OPTS = {
      handgun: [['<3','<3â€³'],['3-4','3â€“4â€³'],['4-5','4â€“5â€³'],['>5','>5â€³'],['No preference','æ— åå¥½']],
      shotgun: [['<18','<18â€³'],['18-24','18â€“24â€³'],['24-28','24â€“28â€³'],['>28','>28â€³'],['No preference','æ— åå¥½']],
      rifle:   [['<16','<16â€³'],['16-20','16â€“20â€³'],['20-24','20â€“24â€³'],['>24','>24â€³'],['No preference','æ— åå¥½']],
      sniper:  [['<20','<20â€³'],['20-24','20â€“24â€³'],['24-28','24â€“28â€³'],['>28','>28â€³'],['No preference','æ— åå¥½']]
    };

    // æ¸²æŸ“å‡½æ•°
    function renderCalibers() {
      const cdiv = document.getElementById('caliber-options');
      cdiv.innerHTML = '';
      CAL[selectedType].forEach(o => {
        cdiv.innerHTML += `<label><input type="radio" name="caliber" value="${o}"/> ${o}</label>`;
      });
    }
    function renderWeights() {
      const wdiv = document.getElementById('weight-options');
      wdiv.innerHTML = '';
      WEIGHT_OPTS[selectedType].forEach(([v,l]) => {
        wdiv.innerHTML += `<label><input type="radio" name="weightReq" value="${v}"/> ${l}</label>`;
      });
    }
    function renderBarrels() {
      const bdiv = document.getElementById('barrel-options');
      bdiv.innerHTML = '';
      BARREL_OPTS[selectedType].forEach(([v,l]) => {
        bdiv.innerHTML += `<label><input type="radio" name="barrelLength" value="${v}"/> ${l}</label>`;
      });
    }

    // Step3 é€‰æ‹©ç±»å‹åæ¸²æŸ“å£å¾„ã€é‡é‡ã€æªç®¡é•¿åº¦
    document.querySelectorAll('input[name="firearmType"]').forEach(radio => {
      radio.addEventListener('change', e => {
        selectedType = e.target.value;
        renderCalibers();
        renderWeights();
        renderBarrels();
      });
    });

    // Next æŒ‰é’®
    document.getElementById('next-btn').addEventListener('click', () => {
      showStep(++idx);
      if (idx === steps.length - 1) {
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'inline-block';
      }
    });

    // Submit -> è°ƒç”¨åç«¯
    document.getElementById('submit-btn').addEventListener('click', async () => {
      const data = {};
      new FormData(form).forEach((v, k) => data[k] = v);
      const res = await fetch('/recommendation', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      const rd = document.getElementById('results');
      rd.innerHTML = '<h2>TopÂ 3Â Recommendations:</h2>';
      (json.recommendations||[]).forEach(g => {
        rd.innerHTML += `
          <div style="margin-bottom:1rem">
            <strong>${g.name}</strong><br>
            <img src="${g.img||g.link}" alt=""/><br>
            Price: $${parseFloat(g.price?.$numberDouble||g.price).toFixed(2)}
          </div>`;
      });
    });
  </script>
</body>
</html>